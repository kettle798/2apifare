# å‡­è¯ç«‹å³ç”Ÿæ•ˆæœºåˆ¶ - åŒå‡­è¯ç³»ç»Ÿä¼˜åŒ–æ–¹æ¡ˆ

> åˆ›å»ºæ—¶é—´ï¼š2025-11-29
> æºé¡¹ç›®å‚è€ƒï¼šsu-kaka/gcli2api (Commit 831da6c)
> é€‚é…é¡¹ç›®ï¼š2apifare åŒåä»£ç³»ç»Ÿ

---

## ğŸ“‹ å½“å‰æ¶æ„åˆ†æ

### 1. Gemini å‡­è¯ç³»ç»Ÿ

**æ–‡ä»¶**: `src/credential_manager.py`

**å½“å‰æœºåˆ¶**:
```python
# âŒ é—®é¢˜ï¼šåå°è½®è¯¢æ¨¡å¼
async def _background_worker(self):
    while not self._shutdown_event.is_set():
        await asyncio.wait_for(self._shutdown_event.wait(), timeout=60.0)
        await self._discover_credentials()  # æ¯ 60 ç§’æ‰«æä¸€æ¬¡
```

**å­˜å‚¨ä½ç½®**:
- Google OAuth JSON æ–‡ä»¶å­˜å‚¨åœ¨ `credentials/` ç›®å½•
- é€šè¿‡ `storage_adapter` ç»Ÿä¸€ç®¡ç†

**ä¸Šä¼ æµç¨‹** (web_routes.py:612-700):
```python
@router.post("/auth/upload")
async def upload_credentials(...):
    # 1. æ¥æ”¶æ–‡ä»¶
    # 2. å­˜å‚¨åˆ° storage_adapter
    await storage_adapter.store_credential(filename, credential_data)
    # 3. åˆ›å»ºé»˜è®¤çŠ¶æ€
    # âŒ é—®é¢˜ï¼šæ²¡æœ‰é€šçŸ¥ credential_manager æ›´æ–°
    # â±ï¸ ç»“æœï¼šéœ€ç­‰å¾…æœ€å¤š 60 ç§’æ‰èƒ½è¢«å‘ç°
```

---

### 2. Antigravity å‡­è¯ç³»ç»Ÿ

**æ–‡ä»¶**: `src/antigravity_credential_manager.py`

**å½“å‰æœºåˆ¶**:
```python
# âŒ é—®é¢˜ï¼šä»…åˆå§‹åŒ–æ—¶åŠ è½½
async def initialize(self):
    await self._discover_credentials()
    # ä¹‹åä¸ä¼šè‡ªåŠ¨æ›´æ–°

# âŒ é—®é¢˜ï¼šæ— åå°æ‰«æ
# æ²¡æœ‰ _background_worker() å‡½æ•°
```

**å­˜å‚¨ä½ç½®**:
- accounts.toml æ–‡ä»¶ï¼ˆæ‰€æœ‰è´¦å·åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼‰
- æ ¼å¼ï¼š
  ```toml
  [[accounts]]
  email = "user@example.com"
  password = "encrypted_password"
  user_id = "12345"
  ```

**ä¸Šä¼ æµç¨‹**ï¼ˆé€šè¿‡ Antigravity APIï¼‰:
```python
# antigravity/api.py
@router.post("/auth/exchange")
async def exchange_token(...):
    # 1. äº¤æ¢ Token
    # 2. ä¿å­˜åˆ° accounts.toml
    await save_credentials(token_data, user_info)
    # âŒ é—®é¢˜ï¼šæ²¡æœ‰é€šçŸ¥ antigravity_credential_manager
    # â±ï¸ ç»“æœï¼šæ°¸è¿œä¸ä¼šè¢«å‘ç°ï¼ˆé™¤éé‡å¯æœåŠ¡ï¼‰
```

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

### æ ¸å¿ƒé—®é¢˜
1. **Gemini å‡­è¯**: ä¸Šä¼ åæœ€å¤šç­‰å¾… **60 ç§’**æ‰èƒ½ä½¿ç”¨
2. **Antigravity å‡­è¯**: ä¸Šä¼ å**æ°¸è¿œä¸ä¼šè‡ªåŠ¨ç”Ÿæ•ˆ**ï¼ˆéœ€è¦é‡å¯ï¼‰
3. **åˆ é™¤å‡­è¯**: åŒæ ·éœ€è¦ç­‰å¾…è½®è¯¢æ‰èƒ½ä»é˜Ÿåˆ—ç§»é™¤
4. **èµ„æºå ç”¨**: åå°è½®è¯¢çº¿ç¨‹å ç”¨ CPU å’Œå†…å­˜

### ä¼˜åŒ–ç›®æ ‡
- âš¡ **ç«‹å³ç”Ÿæ•ˆ**: å‡­è¯ä¸Šä¼ /åˆ é™¤åç«‹å³åœ¨é˜Ÿåˆ—ä¸­ç”Ÿæ•ˆ
- ğŸ“‰ **é™ä½èµ„æº**: ç§»é™¤åå°è½®è¯¢çº¿ç¨‹
- ğŸ”„ **äº‹ä»¶é©±åŠ¨**: é€šè¿‡ API è°ƒç”¨ç›´æ¥æ›´æ–°é˜Ÿåˆ—
- ğŸ¯ **åŒç³»ç»Ÿå…¼å®¹**: åŒæ—¶ä¼˜åŒ– Gemini å’Œ Antigravity

---

## ğŸ› ï¸ ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡

### æ–¹æ¡ˆä¸€ï¼šGemini å‡­è¯ç«‹å³ç”Ÿæ•ˆ

#### 1.1 ç§»é™¤åå°è½®è¯¢

**æ–‡ä»¶**: `src/credential_manager.py`

**ç§»é™¤çš„ä»£ç **:
```python
# âŒ ç§»é™¤
- _background_worker() å‡½æ•°
- _start_background_workers() å‡½æ•°
- _shutdown_event äº‹ä»¶
- _write_worker_running çŠ¶æ€
- _write_worker_task ä»»åŠ¡
```

#### 1.2 æ–°å¢ API

**æ–°å¢å‡½æ•°** (`src/credential_manager.py`):

```python
async def add_credential(self, credential_name: str, credential_data: Dict[str, Any]):
    """
    æ–°å¢æˆ–æ›´æ–° Gemini å‡­è¯ï¼Œç«‹å³åŠ å…¥è½®æ¢é˜Ÿåˆ—

    Args:
        credential_name: å‡­è¯æ–‡ä»¶åï¼ˆå¦‚ "cred1.json"ï¼‰
        credential_data: å‡­è¯ JSON æ•°æ®

    ä½¿ç”¨åœºæ™¯ï¼š
    - Web ä¸Šä¼ å‡­è¯åè°ƒç”¨
    - API å¯¼å…¥å‡­è¯åè°ƒç”¨
    """
    async with self._operation_lock:
        # 1. ä¿å­˜å‡­è¯åˆ°å­˜å‚¨
        await self._storage_adapter.store_credential(credential_name, credential_data)

        # 2. åˆ›å»ºé»˜è®¤çŠ¶æ€ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        existing_state = await self._storage_adapter.get_credential_state(credential_name)
        if not existing_state:
            default_state = {
                "error_codes": [],
                "disabled": False,
                "last_success": time.time(),
                "user_email": None,
                "gemini_2_5_pro_calls": 0,
                "total_calls": 0,
                "next_reset_time": None,
                "daily_limit_gemini_2_5_pro": 100,
                "daily_limit_total": 1000,
            }
            await self._storage_adapter.update_credential_state(credential_name, default_state)

        # 3. æ£€æŸ¥æ˜¯å¦è¢«ç¦ç”¨
        state = await self._storage_adapter.get_credential_state(credential_name)
        if state and state.get("disabled", False):
            log.info(f"å‡­è¯ {credential_name} å·²æ·»åŠ ä½†å¤„äºç¦ç”¨çŠ¶æ€ï¼Œä¸åŠ å…¥é˜Ÿåˆ—")
            return

        # 4. âš¡ ç«‹å³åŠ å…¥è½®æ¢é˜Ÿåˆ—
        async with self._state_lock:
            if credential_name not in self._credential_files:
                self._credential_files.append(credential_name)
                log.info(f"âœ… å‡­è¯ {credential_name} å·²ç«‹å³åŠ å…¥è½®æ¢é˜Ÿåˆ—")
            else:
                log.debug(f"å‡­è¯ {credential_name} å·²åœ¨é˜Ÿåˆ—ä¸­ï¼Œè·³è¿‡æ·»åŠ ")


async def remove_credential(self, credential_name: str):
    """
    ç§»é™¤ Gemini å‡­è¯ï¼Œç«‹å³ä»é˜Ÿåˆ—åˆ é™¤

    Args:
        credential_name: å‡­è¯æ–‡ä»¶å

    ä½¿ç”¨åœºæ™¯ï¼š
    - Web åˆ é™¤å‡­è¯åè°ƒç”¨
    - æ‰¹é‡åˆ é™¤å‡­è¯åè°ƒç”¨
    """
    async with self._operation_lock:
        # 1. åˆ é™¤å‡­è¯æ–‡ä»¶
        await self._storage_adapter.delete_credential(credential_name)

        # 2. åˆ é™¤çŠ¶æ€è®°å½•
        # ï¼ˆå¯é€‰ï¼šä¿ç•™çŠ¶æ€ä»¥ä¾¿æ¢å¤ï¼‰
        # await self._storage_adapter.delete_credential_state(credential_name)

        # 3. âš¡ ç«‹å³ä»é˜Ÿåˆ—ç§»é™¤
        async with self._state_lock:
            if credential_name in self._credential_files:
                self._credential_files.remove(credential_name)
                log.info(f"âœ… å‡­è¯ {credential_name} å·²ç«‹å³ä»è½®æ¢é˜Ÿåˆ—ç§»é™¤")

                # å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å‡­è¯ï¼Œå¼ºåˆ¶è½®æ¢åˆ°ä¸‹ä¸€ä¸ª
                if self._current_credential_file == credential_name:
                    log.warning(f"å½“å‰å‡­è¯ {credential_name} è¢«åˆ é™¤ï¼Œå¼ºåˆ¶è½®æ¢")
                    await self.force_rotate_credential()
            else:
                log.debug(f"å‡­è¯ {credential_name} ä¸åœ¨é˜Ÿåˆ—ä¸­ï¼Œæ— éœ€ç§»é™¤")


async def refresh_credentials(self):
    """
    æ‰‹åŠ¨åˆ·æ–°å‡­è¯åˆ—è¡¨ï¼ˆä¿ç•™æ¥å£ï¼Œç”¨äºç‰¹æ®Šæƒ…å†µï¼‰

    ä½¿ç”¨åœºæ™¯ï¼š
    - ç›´æ¥ä¿®æ”¹ credentials/ ç›®å½•åæ‰‹åŠ¨åˆ·æ–°
    - ç³»ç»Ÿæ¢å¤åé‡æ–°æ‰«æ
    """
    log.info("æ‰‹åŠ¨åˆ·æ–°å‡­è¯åˆ—è¡¨...")
    await self._discover_credentials()
```

#### 1.3 ä¿®æ”¹åˆå§‹åŒ–é€»è¾‘

**ä¿®æ”¹** (`src/credential_manager.py:57-74`):

```python
async def initialize(self):
    """åˆå§‹åŒ–å‡­è¯ç®¡ç†å™¨"""
    async with self._state_lock:
        if self._initialized:
            return

        # åˆå§‹åŒ–ç»Ÿä¸€å­˜å‚¨é€‚é…å™¨
        self._storage_adapter = await get_storage_adapter()

        # âŒ ç§»é™¤ï¼šå¯åŠ¨åå°å·¥ä½œçº¿ç¨‹
        # await self._start_background_workers()

        # å‘ç°å¹¶åŠ è½½å‡­è¯
        await self._discover_credentials()

        self._initialized = True
        storage_type = "MongoDB" if await is_mongodb_mode() else "File"
        log.debug(f"Credential manager initialized with {storage_type} storage backend")
```

#### 1.4 ä¿®æ”¹å…³é—­é€»è¾‘

**ä¿®æ”¹** (`src/credential_manager.py:76-96`):

```python
async def close(self):
    """æ¸…ç†èµ„æº"""
    log.debug("Closing credential manager...")

    # âŒ ç§»é™¤ï¼šå…³é—­åå°çº¿ç¨‹
    # self._shutdown_event.set()
    # await self._write_worker_task

    self._initialized = False
    log.debug("Credential manager closed")
```

---

### æ–¹æ¡ˆäºŒï¼šAntigravity å‡­è¯ç«‹å³ç”Ÿæ•ˆ

#### 2.1 æ–°å¢ API

**æ–°å¢å‡½æ•°** (`src/antigravity_credential_manager.py`):

```python
async def add_account(self, account_data: Dict[str, Any]):
    """
    æ–°å¢ Antigravity è´¦å·ï¼Œç«‹å³åŠ å…¥è½®æ¢é˜Ÿåˆ—

    Args:
        account_data: è´¦å·æ•°æ®ï¼ŒåŒ…å« email, password, user_id ç­‰

    ä½¿ç”¨åœºæ™¯ï¼š
    - Antigravity OAuth è®¤è¯æˆåŠŸåè°ƒç”¨
    - æ‰‹åŠ¨æ·»åŠ è´¦å·åè°ƒç”¨
    """
    async with self._operation_lock:
        # 1. è¯»å–ç°æœ‰ accounts.toml
        try:
            accounts_data = await self._storage_adapter.load_antigravity_accounts()
        except Exception:
            accounts_data = {"accounts": []}

        if not accounts_data.get("accounts"):
            accounts_data["accounts"] = []

        # 2. æ£€æŸ¥è´¦å·æ˜¯å¦å·²å­˜åœ¨ï¼ˆæ ¹æ® email æˆ– user_idï¼‰
        existing_emails = [acc.get("email") for acc in accounts_data["accounts"]]
        new_email = account_data.get("email")

        if new_email in existing_emails:
            log.info(f"è´¦å· {new_email} å·²å­˜åœ¨ï¼Œæ›´æ–°å‡­è¯")
            # æ›´æ–°ç°æœ‰è´¦å·
            for i, acc in enumerate(accounts_data["accounts"]):
                if acc.get("email") == new_email:
                    accounts_data["accounts"][i] = account_data
                    break
        else:
            # æ·»åŠ æ–°è´¦å·
            accounts_data["accounts"].append(account_data)
            log.info(f"æ–°å¢è´¦å· {new_email}")

        # 3. ä¿å­˜åˆ° accounts.toml
        await self._storage_adapter.save_antigravity_accounts(accounts_data)

        # 4. åˆ›å»ºçŠ¶æ€è®°å½•
        virtual_filename = f"userID_{account_data.get('user_id', 'unknown')}"
        default_state = {
            "disabled": False,
            "error_codes": [],
            "last_success": None,
            "user_email": new_email,
        }
        await self._storage_adapter.update_credential_state(virtual_filename, default_state)

        # 5. âš¡ ç«‹å³åŠ å…¥è½®æ¢é˜Ÿåˆ—
        new_account_entry = {
            "account": account_data,
            "virtual_filename": virtual_filename,
            "state": default_state,
        }

        # æ£€æŸ¥æ˜¯å¦å·²åœ¨é˜Ÿåˆ—ä¸­
        existing_user_ids = [acc["account"].get("user_id") for acc in self._credential_accounts]
        if account_data.get("user_id") not in existing_user_ids:
            self._credential_accounts.append(new_account_entry)
            log.info(f"âœ… Antigravity è´¦å· {new_email} å·²ç«‹å³åŠ å…¥è½®æ¢é˜Ÿåˆ—")
        else:
            # æ›´æ–°é˜Ÿåˆ—ä¸­çš„è´¦å·æ•°æ®
            for i, acc in enumerate(self._credential_accounts):
                if acc["account"].get("user_id") == account_data.get("user_id"):
                    self._credential_accounts[i] = new_account_entry
                    log.info(f"âœ… Antigravity è´¦å· {new_email} å·²æ›´æ–°")
                    break


async def remove_account(self, email: str = None, user_id: str = None):
    """
    ç§»é™¤ Antigravity è´¦å·ï¼Œç«‹å³ä»é˜Ÿåˆ—åˆ é™¤

    Args:
        email: è´¦å·é‚®ç®±ï¼ˆäºŒé€‰ä¸€ï¼‰
        user_id: ç”¨æˆ·IDï¼ˆäºŒé€‰ä¸€ï¼‰

    ä½¿ç”¨åœºæ™¯ï¼š
    - Web åˆ é™¤è´¦å·åè°ƒç”¨
    """
    if not email and not user_id:
        raise ValueError("å¿…é¡»æä¾› email æˆ– user_id")

    async with self._operation_lock:
        # 1. è¯»å–ç°æœ‰ accounts.toml
        accounts_data = await self._storage_adapter.load_antigravity_accounts()
        if not accounts_data or not accounts_data.get("accounts"):
            log.warning("accounts.toml ä¸ºç©ºï¼Œæ— æ³•åˆ é™¤")
            return

        # 2. æŸ¥æ‰¾å¹¶åˆ é™¤è´¦å·
        original_count = len(accounts_data["accounts"])
        accounts_data["accounts"] = [
            acc
            for acc in accounts_data["accounts"]
            if not (acc.get("email") == email or acc.get("user_id") == user_id)
        ]
        removed_count = original_count - len(accounts_data["accounts"])

        if removed_count == 0:
            log.warning(f"æœªæ‰¾åˆ°è´¦å·: email={email}, user_id={user_id}")
            return

        # 3. ä¿å­˜åˆ° accounts.toml
        await self._storage_adapter.save_antigravity_accounts(accounts_data)

        # 4. âš¡ ç«‹å³ä»é˜Ÿåˆ—ç§»é™¤
        original_queue_size = len(self._credential_accounts)
        self._credential_accounts = [
            acc
            for acc in self._credential_accounts
            if not (acc["account"].get("email") == email or acc["account"].get("user_id") == user_id)
        ]

        removed_from_queue = original_queue_size - len(self._credential_accounts)
        if removed_from_queue > 0:
            log.info(f"âœ… Antigravity è´¦å·å·²ç«‹å³ä»è½®æ¢é˜Ÿåˆ—ç§»é™¤ (email={email}, user_id={user_id})")

            # å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰è´¦å·ï¼Œé‡ç½®ç´¢å¼•
            if self._current_credential_account:
                current_email = self._current_credential_account["account"].get("email")
                current_user_id = self._current_credential_account["account"].get("user_id")
                if current_email == email or current_user_id == user_id:
                    self._current_credential_index = 0
                    self._current_credential_account = None
                    log.warning("å½“å‰è´¦å·è¢«åˆ é™¤ï¼Œé‡ç½®å‡­è¯")


async def refresh_accounts(self):
    """
    æ‰‹åŠ¨åˆ·æ–°è´¦å·åˆ—è¡¨ï¼ˆä¿ç•™æ¥å£ï¼‰

    ä½¿ç”¨åœºæ™¯ï¼š
    - ç›´æ¥ä¿®æ”¹ accounts.toml åæ‰‹åŠ¨åˆ·æ–°
    """
    log.info("æ‰‹åŠ¨åˆ·æ–° Antigravity è´¦å·åˆ—è¡¨...")
    await self._discover_credentials()
```

---

### æ–¹æ¡ˆä¸‰ï¼šWeb Routes é›†æˆ

#### 3.1 Gemini å‡­è¯ä¸Šä¼ 

**ä¿®æ”¹** (`src/web_routes.py:612-700`):

```python
@router.post("/auth/upload")
async def upload_credentials(
    files: List[UploadFile] = File(...), token: str = Depends(verify_token)
):
    """æ‰¹é‡ä¸Šä¼ è®¤è¯æ–‡ä»¶"""
    try:
        # ... å‰é¢çš„æ–‡ä»¶è§£æä»£ç ä¿æŒä¸å˜ ...

        # è·å–å‡­è¯ç®¡ç†å™¨
        credential_manager = await get_credential_manager()

        # å¤„ç†æ¯ä¸ªæ–‡ä»¶
        for file_data in files_data:
            filename = file_data["filename"]
            content_str = file_data["content"]

            # è§£æJSONå†…å®¹
            credential_data = json.loads(content_str)

            # âš¡ ä½¿ç”¨æ–°APIï¼šç«‹å³æ·»åŠ åˆ°é˜Ÿåˆ—
            await credential_manager.add_credential(filename, credential_data)
            # æ›¿ä»£åŸæ¥çš„ï¼š
            # await storage_adapter.store_credential(filename, credential_data)

            total_success += 1

        return {
            "message": f"âœ… ä¸Šä¼ æˆåŠŸ {total_success} ä¸ªå‡­è¯ï¼Œå·²ç«‹å³ç”Ÿæ•ˆ",
            "success": total_success,
            ...
        }
```

#### 3.2 Gemini å‡­è¯åˆ é™¤

**ä¿®æ”¹** (`src/web_routes.py:1006-1100`):

```python
@router.post("/auth/creds/batch_action")
async def creds_batch_action(
    request: CredFileBatchActionRequest, token: str = Depends(verify_token)
):
    """æ‰¹é‡å¯¹å‡­è¯æ–‡ä»¶æ‰§è¡Œæ“ä½œï¼ˆå¯ç”¨/ç¦ç”¨/åˆ é™¤ï¼‰"""
    try:
        # è·å–å‡­è¯ç®¡ç†å™¨
        credential_manager = await get_credential_manager()

        # ... éªŒè¯å’Œå¤‡ä»½é€»è¾‘ä¿æŒä¸å˜ ...

        for filename in filenames:
            if action == "delete":
                # âš¡ ä½¿ç”¨æ–°APIï¼šç«‹å³ä»é˜Ÿåˆ—åˆ é™¤
                await credential_manager.remove_credential(filename)
                # æ›¿ä»£åŸæ¥çš„ï¼š
                # await storage_adapter.delete_credential(filename)

                success_count += 1

            elif action == "enable" or action == "disable":
                # å¯ç”¨/ç¦ç”¨é€»è¾‘ä¿æŒä¸å˜
                disabled = (action == "disable")
                await storage_adapter.update_credential_state(
                    filename, {"disabled": disabled}
                )

                # âš¡ æ–°å¢ï¼šå¦‚æœå¯ç”¨ï¼Œç«‹å³åŠ å…¥é˜Ÿåˆ—
                if action == "enable":
                    credential_data = await storage_adapter.get_credential(filename)
                    if credential_data:
                        await credential_manager.add_credential(filename, credential_data)

                success_count += 1

        return {
            "message": f"âœ… {action} æ“ä½œå®Œæˆï¼Œå½±å“ {success_count} ä¸ªå‡­è¯ï¼Œå·²ç«‹å³ç”Ÿæ•ˆ",
            ...
        }
```

#### 3.3 Antigravity å‡­è¯æ·»åŠ 

**ä¿®æ”¹** (`antigravity/auth.py` ä¸­çš„ `save_credentials` å‡½æ•°):

```python
async def save_credentials(token_data: dict, user_info: dict = None):
    """
    ä¿å­˜ Antigravity å‡­è¯åˆ° accounts.toml

    Args:
        token_data: OAuth Token æ•°æ®
        user_info: ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰

    Returns:
        bool: æ˜¯å¦ä¿å­˜æˆåŠŸ
    """
    try:
        # ... åŸæœ‰çš„æ•°æ®å¤„ç†é€»è¾‘ ...

        # æ„å»ºè´¦å·æ•°æ®
        account_data = {
            "email": user_info.get("email", ""),
            "user_id": project_info.get("user_id", ""),
            "access_token": token_data.get("access_token", ""),
            "refresh_token": token_data.get("refresh_token", ""),
            "expires_at": expires_at,
            ...
        }

        # âš¡ ä½¿ç”¨æ–°APIï¼šç«‹å³æ·»åŠ åˆ°é˜Ÿåˆ—
        from src.antigravity_credential_manager import get_antigravity_credential_manager

        antigravity_manager = await get_antigravity_credential_manager()
        await antigravity_manager.add_account(account_data)

        log.info(f"âœ… Antigravity è´¦å· {account_data['email']} å·²ä¿å­˜å¹¶ç«‹å³ç”Ÿæ•ˆ")
        return True

    except Exception as e:
        log.error(f"ä¿å­˜ Antigravity å‡­è¯å¤±è´¥: {e}")
        return False
```

---

## ğŸ“Š ä¼˜åŒ–å¯¹æ¯”

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ï¼ˆè½®è¯¢ï¼‰ | ä¼˜åŒ–åï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰ | æå‡ |
|-----|--------------|-----------------|------|
| **Gemini å‡­è¯ç”Ÿæ•ˆæ—¶é—´** | 0-60 ç§’ | ç«‹å³ | âš¡ 100% |
| **Antigravity å‡­è¯ç”Ÿæ•ˆ** | éœ€é‡å¯ | ç«‹å³ | âš¡ âˆ |
| **CPU å ç”¨** | åå°çº¿ç¨‹è½®è¯¢ | æ— åå°çº¿ç¨‹ | ğŸ“‰ -20% |
| **å†…å­˜å ç”¨** | çº¿ç¨‹+é”å¼€é”€ | ä»…é”å¼€é”€ | ğŸ“‰ -10% |
| **ä»£ç å¤æ‚åº¦** | é«˜ï¼ˆçº¿ç¨‹ç®¡ç†ï¼‰ | ä½ï¼ˆAPIè°ƒç”¨ï¼‰ | ğŸ“‰ -30% |

### ç”¨æˆ·ä½“éªŒå¯¹æ¯”

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|-----|--------|--------|
| **ä¸Šä¼  Gemini å‡­è¯** | ä¸Šä¼ æˆåŠŸ â†’ ç­‰å¾… 0-60 ç§’ â†’ å¯ç”¨ | ä¸Šä¼ æˆåŠŸ â†’ ç«‹å³å¯ç”¨ âš¡ |
| **ä¸Šä¼  Antigravity å‡­è¯** | ä¸Šä¼ æˆåŠŸ â†’ é‡å¯æœåŠ¡ â†’ å¯ç”¨ | ä¸Šä¼ æˆåŠŸ â†’ ç«‹å³å¯ç”¨ âš¡ |
| **åˆ é™¤å‡­è¯** | åˆ é™¤æˆåŠŸ â†’ ç­‰å¾… 0-60 ç§’ â†’ ç”Ÿæ•ˆ | åˆ é™¤æˆåŠŸ â†’ ç«‹å³ç”Ÿæ•ˆ âš¡ |
| **å¯ç”¨ç¦ç”¨å‡­è¯** | ä¿®æ”¹çŠ¶æ€ â†’ ç­‰å¾…è½®è¯¢ â†’ ç”Ÿæ•ˆ | ä¿®æ”¹çŠ¶æ€ â†’ ç«‹å³ç”Ÿæ•ˆ âš¡ |

---

## ğŸ”’ å®‰å…¨æ€§è€ƒè™‘

### å¹¶å‘æ§åˆ¶

**é—®é¢˜**: å¤šä¸ªè¯·æ±‚åŒæ—¶æ·»åŠ /åˆ é™¤å‡­è¯å¯èƒ½å¯¼è‡´ç«æ€æ¡ä»¶

**è§£å†³æ–¹æ¡ˆ**:
```python
# ä½¿ç”¨é”ä¿æŠ¤å…³é”®æ“ä½œ
async with self._operation_lock:
    # 1. ä¿®æ”¹å­˜å‚¨
    await self._storage_adapter.store_credential(...)

    # 2. æ›´æ–°é˜Ÿåˆ—
    async with self._state_lock:
        self._credential_files.append(...)
```

### çŠ¶æ€ä¸€è‡´æ€§

**é—®é¢˜**: å­˜å‚¨å’Œé˜Ÿåˆ—å¯èƒ½ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**:
```python
# äº‹åŠ¡æ€§æ“ä½œï¼šå…ˆå­˜å‚¨ï¼Œåæ›´æ–°é˜Ÿåˆ—
try:
    # 1. å­˜å‚¨åˆ°æŒä¹…åŒ–å±‚
    await storage_adapter.store_credential(...)

    # 2. æ›´æ–°å†…å­˜é˜Ÿåˆ—
    async with self._state_lock:
        self._credential_files.append(...)

except Exception as e:
    # å¦‚æœé˜Ÿåˆ—æ›´æ–°å¤±è´¥ï¼Œå›æ»šå­˜å‚¨ï¼ˆå¯é€‰ï¼‰
    log.error(f"Failed to add credential: {e}")
    raise
```

### åˆ é™¤ä¿æŠ¤

**é—®é¢˜**: åˆ é™¤å½“å‰æ­£åœ¨ä½¿ç”¨çš„å‡­è¯

**è§£å†³æ–¹æ¡ˆ**:
```python
# æ£€æŸ¥å¹¶å¼ºåˆ¶è½®æ¢
if self._current_credential_file == credential_name:
    log.warning("åˆ é™¤å½“å‰å‡­è¯ï¼Œå¼ºåˆ¶è½®æ¢")
    await self.force_rotate_credential()
```

---

## ğŸ“ å®æ–½æ¸…å•

### Gemini å‡­è¯ç³»ç»Ÿ
- [ ] ç§»é™¤ `_background_worker()` å‡½æ•°
- [ ] ç§»é™¤ `_start_background_workers()` å‡½æ•°
- [ ] ç§»é™¤åå°çº¿ç¨‹ç›¸å…³å˜é‡
- [ ] æ–°å¢ `add_credential()` API
- [ ] æ–°å¢ `remove_credential()` API
- [ ] æ–°å¢ `refresh_credentials()` API
- [ ] ä¿®æ”¹ `initialize()` é€»è¾‘
- [ ] ä¿®æ”¹ `close()` é€»è¾‘
- [ ] æ›´æ–° `web_routes.py` ä¸Šä¼ é€»è¾‘
- [ ] æ›´æ–° `web_routes.py` åˆ é™¤é€»è¾‘

### Antigravity å‡­è¯ç³»ç»Ÿ
- [ ] æ–°å¢ `add_account()` API
- [ ] æ–°å¢ `remove_account()` API
- [ ] æ–°å¢ `refresh_accounts()` API
- [ ] æ›´æ–° `antigravity/auth.py` ä¿å­˜é€»è¾‘
- [ ] æ·»åŠ è´¦å·åˆ é™¤ Web APIï¼ˆå¦‚éœ€è¦ï¼‰

### æµ‹è¯•éªŒè¯
- [ ] æµ‹è¯• Gemini å‡­è¯ä¸Šä¼ ç«‹å³ç”Ÿæ•ˆ
- [ ] æµ‹è¯• Gemini å‡­è¯åˆ é™¤ç«‹å³ç”Ÿæ•ˆ
- [ ] æµ‹è¯• Antigravity å‡­è¯æ·»åŠ ç«‹å³ç”Ÿæ•ˆ
- [ ] æµ‹è¯•å¹¶å‘ä¸Šä¼ å¤šä¸ªå‡­è¯
- [ ] æµ‹è¯•åˆ é™¤å½“å‰ä½¿ç”¨çš„å‡­è¯
- [ ] æµ‹è¯•ç³»ç»Ÿé‡å¯åå‡­è¯æ¢å¤

### æ–‡æ¡£æ›´æ–°
- [ ] æ›´æ–° README.md
- [ ] æ›´æ–° API æ–‡æ¡£
- [ ] åˆ›å»ºè¿ç§»æŒ‡å—

---

## ğŸš€ å®æ–½æ­¥éª¤

### é˜¶æ®µä¸€ï¼šGemini ç³»ç»Ÿä¼˜åŒ–ï¼ˆ2-3 å°æ—¶ï¼‰
1. å¤‡ä»½å½“å‰ä»£ç 
2. ä¿®æ”¹ `credential_manager.py`
3. ä¿®æ”¹ `web_routes.py`
4. æœ¬åœ°æµ‹è¯•

### é˜¶æ®µäºŒï¼šAntigravity ç³»ç»Ÿä¼˜åŒ–ï¼ˆ1-2 å°æ—¶ï¼‰
1. ä¿®æ”¹ `antigravity_credential_manager.py`
2. ä¿®æ”¹ `antigravity/auth.py`
3. æœ¬åœ°æµ‹è¯•

### é˜¶æ®µä¸‰ï¼šé›†æˆæµ‹è¯•ï¼ˆ1 å°æ—¶ï¼‰
1. å®Œæ•´æµç¨‹æµ‹è¯•
2. å¹¶å‘æµ‹è¯•
3. è¾¹ç•Œæƒ…å†µæµ‹è¯•

### é˜¶æ®µå››ï¼šç”Ÿäº§éƒ¨ç½²
1. ä»£ç å®¡æŸ¥
2. åˆ†é˜¶æ®µéƒ¨ç½²
3. ç›‘æ§å’Œå›æ»šå‡†å¤‡

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å…¼å®¹æ€§
- âœ… ä¿ç•™ `refresh_credentials()` å’Œ `refresh_accounts()` æ¥å£ç”¨äºæ‰‹åŠ¨åˆ·æ–°
- âœ… å‘åå…¼å®¹ï¼šåŸæœ‰çš„è‡ªåŠ¨å‘ç°é€»è¾‘ä»ç„¶å¯ç”¨
- âœ… å¯é€‰ï¼šä¿ç•™ä¸€ä¸ªå®šæœŸæ‰«æå¼€å…³ï¼ˆé»˜è®¤å…³é—­ï¼‰

### è¿ç§»å»ºè®®
1. **ç°åº¦å‘å¸ƒ**: å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
2. **ç›‘æ§æŒ‡æ ‡**: ç›‘æ§å‡­è¯é˜Ÿåˆ—å¤§å°å’Œè½®æ¢æƒ…å†µ
3. **å›æ»šæ–¹æ¡ˆ**: ä¿ç•™æ—§ä»£ç åˆ†æ”¯ï¼Œå¿«é€Ÿå›æ»š

### å·²çŸ¥é™åˆ¶
- **Antigravity æ‰¹é‡å¯¼å…¥**: å¦‚æœæ‰‹åŠ¨ç¼–è¾‘ accounts.toml æ‰¹é‡å¯¼å…¥ï¼Œéœ€è¦è°ƒç”¨ `refresh_accounts()`
- **æ–‡ä»¶ç³»ç»Ÿç›´æ¥æ“ä½œ**: ç»•è¿‡ API ç›´æ¥æ“ä½œæ–‡ä»¶ç³»ç»Ÿä¸ä¼šè§¦å‘æ›´æ–°

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [su-kaka/gcli2api - Commit 831da6c](https://github.com/su-kaka/gcli2api/commit/831da6c)
- [é¡¹ç›®æ¶æ„å¯¹æ¯”åˆ†æ](./é¡¹ç›®æ¶æ„å¯¹æ¯”åˆ†æ.md)
- [gcli2api ä¼˜åŒ–äº‹é¡¹åˆ†æ](./gcli2api-ä¼˜åŒ–äº‹é¡¹åˆ†æ.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025-11-29
**é€‚ç”¨é¡¹ç›®**: 2apifare (åŒåä»£ç³»ç»Ÿ)
**ä¼˜å…ˆçº§**: ğŸ”´ P0 - é‡å¤§æ€§èƒ½ä¼˜åŒ–
