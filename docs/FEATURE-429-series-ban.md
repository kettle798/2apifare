# Antigravity 429 ç²¾ç»†åŒ–ä¸´æ—¶å°ç¦æœºåˆ¶

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†é’ˆå¯¹ **Antigravity API** çš„ 429 é”™è¯¯ç²¾ç»†åŒ–å¤„ç†æœºåˆ¶ï¼Œæ”¯æŒï¼š
- âœ… **ç³»åˆ—çº§ä¸´æ—¶å°ç¦**ï¼ˆClaude ç³»åˆ— / Gemini 3 ç³»åˆ—åˆ†åˆ«ç®¡ç†ï¼‰
- âœ… **æ™ºèƒ½è§£æ API è¿”å›çš„é…é¢é‡ç½®æ—¶é—´**
- âœ… **è‡ªåŠ¨è®¡ç®—å°ç¦æ—¶é•¿**ï¼ˆAPI è¿”å›æ—¶é—´ Ã— 2ï¼Œé»˜è®¤ 6 å°æ—¶ï¼‰
- âœ… **å°ç¦åˆ°æœŸè‡ªåŠ¨è§£å°**
- âœ… **429 é”™è¯¯ç«‹å³åˆ‡æ¢å‡­è¯**

---

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. ä¸ºä»€ä¹ˆæŒ‰ç³»åˆ—å°ç¦ï¼Ÿ

æ ¹æ®ç”¨æˆ·åé¦ˆå’Œå®é™…æµ‹è¯•ï¼ŒGoogle Antigravity API çš„é…é¢æ˜¯**æŒ‰ç³»åˆ—å…±äº«**çš„ï¼š

**Claude ç³»åˆ—**ï¼ˆå…±äº«é…é¢ï¼‰ï¼š
- `ANT/claude-sonnet-4-5`
- `ANT/claude-sonnet-4-5-thinking`

**Gemini 3 ç³»åˆ—**ï¼ˆå…±äº«é…é¢ï¼‰ï¼š
- `ANT/gemini-3-pro`
- `ANT/gemini-3-pro-high`
- `ANT/gemini-3-pro-low`
- `ANT/gemini-3-pro-image`

**å…³é”®ç‰¹æ€§**ï¼š
- ç”¨å®Œ `gemini-3-pro-high`ï¼Œæ•´ä¸ª Gemini 3 ç³»åˆ—éƒ½ä¼š 429
- ä½† Claude ç³»åˆ—ä»ç„¶å¯ç”¨
- å°ç¦åº”è¯¥æŒ‰ç³»åˆ—çº§åˆ«ï¼Œè€Œä¸æ˜¯æ•´ä¸ªè´¦å·

### 2. ä¸ºä»€ä¹ˆå°ç¦æ—¶é•¿æ˜¯ API è¿”å›æ—¶é—´ Ã— 2ï¼Ÿ

- **é¿å…è¿‡åº¦å‹æ¦¨**ï¼šä¸åœ¨é…é¢åˆšæ¢å¤æ—¶ç«‹å³è¯·æ±‚
- **ç»™ç³»ç»Ÿç¼“å†²æ—¶é—´**ï¼šé˜²æ­¢æ—¶é—´åŒæ­¥è¯¯å·®å¯¼è‡´çš„è¿‡æ—©è¯·æ±‚
- **ç”¨æˆ·æ˜ç¡®è¦æ±‚**ï¼š"æŒ‰ç…§æç¤ºæš‚æ—¶å°ç¦è¿™ä¸ªç³»åˆ—ä¸€æ®µæ—¶é—´ï¼Œåé¢å†æ¢å¤ï¼Œä¸€èˆ¬å°±æ˜¯ç¦æ­¢æ—¶é—´ä¸¤å€é¿å…å¤ªè¿‡å‹æ¦¨"

### 3. ä¸ºä»€ä¹ˆé»˜è®¤ 6 å°æ—¶ï¼Ÿ

å¦‚æœ API æ²¡æœ‰è¿”å›é…é¢é‡ç½®æ—¶é—´ï¼Œä½¿ç”¨ 6 å°æ—¶ä½œä¸ºå®‰å…¨å€¼ï¼š
- è¶³å¤Ÿé•¿ï¼Œé¿å…é¢‘ç¹ 429
- ä¸ä¼šè¿‡é•¿ï¼Œä¸å½±å“æ­£å¸¸ä½¿ç”¨

---

## ğŸ”§ æŠ€æœ¯å®ç°

### æ•°æ®ç»“æ„

åœ¨ `accounts.toml` ä¸­ä¸ºæ¯ä¸ªè´¦å·æ·»åŠ ç³»åˆ—çº§å°ç¦å­—æ®µï¼š

```toml
[[accounts]]
user_id = "118031974975297336154"
email = "example@gmail.com"
# ... å…¶ä»–å­—æ®µ ...

# ç³»åˆ—çº§ä¸´æ—¶å°ç¦æ—¶é—´æˆ³ï¼ˆISO æ ¼å¼ UTCï¼‰
claude_series_banned_until = ""  # ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºæœªå°ç¦
gemini_3_series_banned_until = "2025-11-29T16:09:36+00:00"  # ä¸´æ—¶å°ç¦åˆ°æ­¤æ—¶é—´
```

### æ ¸å¿ƒå‡½æ•°

#### 1. `_parse_429_error_details(error_message: str)`

è§£æ 429 é”™è¯¯å“åº”ï¼Œæå–é…é¢é‡ç½®ä¿¡æ¯ï¼š

```python
# è¾“å…¥ç¤ºä¾‹
error_message = """API è¯·æ±‚å¤±è´¥ (429): {
  "error": {
    "code": 429,
    "message": "You have exhausted your capacity on this model. Your quota will reset after 2h22m50s.",
    "status": "RESOURCE_EXHAUSTED",
    "details": [
      {
        "@type": "type.googleapis.com/google.rpc.ErrorInfo",
        "reason": "QUOTA_EXHAUSTED",
        "domain": "cloudcode-pa.googleapis.com",
        "metadata": {
          "model": "gemini-3-pro-high",
          "quotaResetDelay": "2h22m50.065102829s",
          "quotaResetTimeStamp": "2025-11-29T11:46:46Z"
        }
      }
    ]
  }
}"""

# è¾“å‡º
{
    "model": "gemini-3-pro-high",
    "quota_reset_timestamp": "2025-11-29T11:46:46Z",
    "quota_reset_delay_seconds": 8570
}
```

#### 2. `_identify_model_series(model_name: str)`

è¯†åˆ«æ¨¡å‹æ‰€å±ç³»åˆ—ï¼š

```python
"gemini-3-pro-high" â†’ "gemini_3_series"
"claude-sonnet-4-5" â†’ "claude_series"
```

#### 3. `_handle_429_series_ban(virtual_filename, error_message)`

å¤„ç† 429 é”™è¯¯çš„æ ¸å¿ƒé€»è¾‘ï¼š

```
1. è§£æé”™è¯¯è¯¦æƒ…
   â†“
2. è¯†åˆ«æ¨¡å‹ç³»åˆ—
   â†“
3. è®¡ç®—å°ç¦æ—¶é•¿
   - ä¼˜å…ˆä½¿ç”¨ quotaResetTimeStampï¼ˆå½“å‰æ—¶é—´åˆ°é‡ç½®æ—¶é—´ Ã— 2ï¼‰
   - å…¶æ¬¡ä½¿ç”¨ quotaResetDelayï¼ˆå»¶è¿Ÿç§’æ•° Ã— 2ï¼‰
   - é»˜è®¤ 6 å°æ—¶
   â†“
4. å†™å…¥ accounts.tomlï¼ˆç³»åˆ—å°ç¦æ—¶é—´æˆ³ï¼‰
   â†“
5. æ—¥å¿—è¾“å‡ºå°ç¦ä¿¡æ¯
```

#### 4. `_check_series_ban(account, model_name)`

åœ¨ `get_valid_credential` ä¸­è°ƒç”¨ï¼Œæ£€æŸ¥ç³»åˆ—æ˜¯å¦è¢«å°ç¦ï¼š

```python
# æ£€æŸ¥é€»è¾‘
if now < ban_until:
    # ä»åœ¨å°ç¦æœŸå†…
    log.info(f"[429 BAN] Account {email} - {series} still banned (~X hours remaining)")
    return True  # è·³è¿‡æ­¤è´¦å·
else:
    # å°ç¦å·²è¿‡æœŸï¼Œè‡ªåŠ¨è§£å°
    log.info(f"[429 UNBAN] Account {email} - {series} ban expired, auto-unbanning")
    await _clear_series_ban(user_id, series)
    return False  # å¯ä»¥ä½¿ç”¨
```

### è°ƒç”¨æµç¨‹

```
ç”¨æˆ·è¯·æ±‚ ANT/gemini-3-pro-high
    â†“
get_valid_credential(model_name="ANT/gemini-3-pro-high")
    â†“
æ£€æŸ¥è´¦å· A çš„ gemini_3_series_banned_until
    â”œâ”€ å¦‚æœä»åœ¨å°ç¦æœŸ â†’ åˆ‡æ¢åˆ°è´¦å· B
    â””â”€ å¦‚æœå·²è¿‡æœŸ â†’ è‡ªåŠ¨è§£å°ï¼Œä½¿ç”¨è´¦å· A
    â†“
å‘é€è¯·æ±‚
    â”œâ”€ æˆåŠŸ â†’ è¿”å›ç»“æœ
    â””â”€ 429 é”™è¯¯ â†’
        â”œâ”€ è§£æé”™è¯¯è¯¦æƒ…
        â”œâ”€ ä¸´æ—¶å°ç¦ gemini_3_seriesï¼ˆä¾‹å¦‚ 4.7 å°æ—¶ï¼‰
        â”œâ”€ å¼ºåˆ¶åˆ‡æ¢å‡­è¯
        â””â”€ é‡è¯•ï¼ˆä½¿ç”¨ä¸‹ä¸€ä¸ªè´¦å·ï¼‰
```

---

## ğŸ“Š ç¤ºä¾‹åœºæ™¯

### åœºæ™¯ 1ï¼šæ­£å¸¸ 429 é”™è¯¯å¤„ç†

**è¾“å…¥**ï¼š
```json
{
  "error": {
    "code": 429,
    "details": [{
      "metadata": {
        "model": "gemini-3-pro-high",
        "quotaResetDelay": "2h22m50s"
      }
    }]
  }
}
```

**å¤„ç†**ï¼š
1. è¯†åˆ«ç³»åˆ—ï¼š`gemini_3_series`
2. è®¡ç®—å°ç¦æ—¶é•¿ï¼š2h22m Ã— 2 = **4h45m**
3. è®¾ç½® `gemini_3_series_banned_until = "2025-11-29T16:09:36+00:00"`
4. æ—¥å¿—ï¼š`[429 BAN] Account userID_xxx: gemini_3_series banned until 2025-11-29T16:09:36+00:00 (~4.8 hours) - Model: gemini-3-pro-high`
5. åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè´¦å·ç»§ç»­

### åœºæ™¯ 2ï¼šè§£æå¤±è´¥ä½¿ç”¨é»˜è®¤å€¼

**è¾“å…¥**ï¼š
```
API è¯·æ±‚å¤±è´¥ (429): Unknown error format
```

**å¤„ç†**ï¼š
1. è§£æå¤±è´¥
2. æ—¥å¿—ï¼š`[429] Failed to parse error details, applying default 6-hour ban`
3. é»˜è®¤å°ç¦ `gemini_3_series` **6 å°æ—¶**
4. åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè´¦å·ç»§ç»­

### åœºæ™¯ 3ï¼šè‡ªåŠ¨è§£å°

**åœºæ™¯**ï¼š
- å½“å‰æ—¶é—´ï¼š2025-11-29T16:10:00Z
- `gemini_3_series_banned_until = "2025-11-29T16:09:36+00:00"`ï¼ˆå·²è¿‡æœŸï¼‰

**å¤„ç†**ï¼š
1. `_check_series_ban` æ£€æµ‹åˆ°å°ç¦å·²è¿‡æœŸ
2. æ—¥å¿—ï¼š`[429 UNBAN] Account xxx@gmail.com - gemini_3_series ban expired, auto-unbanning`
3. æ¸…é™¤å°ç¦å­—æ®µï¼š`gemini_3_series_banned_until = ""`
4. è¿”å› Falseï¼ˆå¯ä»¥ä½¿ç”¨ï¼‰

---

## ğŸ¨ æ—¥å¿—æ ¼å¼

### 429 å°ç¦æ—¥å¿—
```
[WARNING] [429 BAN] Account userID_118031974975297336154: gemini_3_series banned until 2025-11-29T16:09:36+00:00 (~4.8 hours) - Model: gemini-3-pro-high
```

### ç³»åˆ—ä»è¢«å°ç¦æ—¥å¿—
```
[INFO] [429 BAN] Account example@gmail.com - gemini_3_series still banned (~2.3 hours remaining)
```

### è‡ªåŠ¨è§£å°æ—¥å¿—
```
[INFO] [429 UNBAN] Account example@gmail.com - gemini_3_series ban expired, auto-unbanning
```

### åˆ‡æ¢å‡­è¯æ—¥å¿—
```
[INFO] Rotating to next account due to series ban
```

---

## âœ… ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | æ—§æ–¹æ¡ˆï¼ˆæ°¸ä¹…ç¦ç”¨ï¼‰ | æ–°æ–¹æ¡ˆï¼ˆä¸´æ—¶å°ç¦ï¼‰ |
|-----|------------------|------------------|
| **å°ç¦ç²’åº¦** | âŒ æ•´ä¸ªè´¦å·æ°¸ä¹…ç¦ç”¨ | âœ… æŒ‰ç³»åˆ—ä¸´æ—¶å°ç¦ |
| **èµ„æºåˆ©ç”¨** | âŒ è´¦å·æµªè´¹ï¼ˆä¸€ä¸ªç³»åˆ—ç”¨å®Œæ•´ä¸ªè´¦å·åºŸå¼ƒï¼‰ | âœ… æœ€å¤§åŒ–èµ„æºåˆ©ç”¨ï¼ˆClaude ç”¨å®Œè¿˜èƒ½ç”¨ Geminiï¼‰ |
| **è‡ªåŠ¨æ¢å¤** | âŒ éœ€è¦æ‰‹åŠ¨é‡æ–°å¯ç”¨ | âœ… åˆ°æœŸè‡ªåŠ¨è§£å° |
| **å°ç¦æ—¶é•¿** | âŒ æ°¸ä¹…ï¼ˆæˆ–æ‰‹åŠ¨è®¾ç½®ï¼‰ | âœ… æ™ºèƒ½è®¡ç®—ï¼ˆAPI æ—¶é—´ Ã— 2ï¼‰ |
| **é”™è¯¯ä¿¡æ¯åˆ©ç”¨** | âŒ ä¸è§£æ API è¿”å› | âœ… å……åˆ†åˆ©ç”¨ quotaResetTimeStamp |
| **å‹æ¦¨ç¨‹åº¦** | âš ï¸ æ‰‹åŠ¨æ§åˆ¶ | âœ… è‡ªåŠ¨é¿å…è¿‡åº¦å‹æ¦¨ï¼ˆÃ— 2 ç¼“å†²ï¼‰ |

---

## ğŸ” å…¼å®¹æ€§è¯´æ˜

### å‘åå…¼å®¹
- âœ… ä¸å½±å“ç°æœ‰é…ç½®
- âœ… æ—§çš„ `disabled` å­—æ®µä»ç„¶æœ‰æ•ˆ
- âœ… é 429 é”™è¯¯ä»ä½¿ç”¨åŸæœ‰é€»è¾‘ï¼ˆ401/403 æ°¸ä¹…ç¦ç”¨ï¼‰

### GeminiCLI ç³»ç»Ÿ
- âš ï¸ **æ­¤åŠŸèƒ½ä»…é€‚ç”¨äº Antigravity ç³»ç»Ÿ**
- GeminiCLI ä¸å—å½±å“ï¼Œç»§ç»­ä½¿ç”¨åŸæœ‰é€»è¾‘

---

## ğŸ› ï¸ ä¿®æ”¹çš„æ–‡ä»¶

1. **src/antigravity_credential_manager.py**ï¼ˆæ ¸å¿ƒå®ç°ï¼‰
   - æ–°å¢ `_parse_duration_to_seconds()` - è§£ææ—¶é•¿å­—ç¬¦ä¸²
   - æ–°å¢ `_parse_429_error_details()` - è§£æ 429 é”™è¯¯è¯¦æƒ…
   - æ–°å¢ `_identify_model_series()` - è¯†åˆ«æ¨¡å‹ç³»åˆ—
   - æ–°å¢ `_handle_429_series_ban()` - å¤„ç† 429 ä¸´æ—¶å°ç¦
   - æ–°å¢ `_set_series_ban()` - è®¾ç½®ç³»åˆ—å°ç¦
   - æ–°å¢ `_check_series_ban()` - æ£€æŸ¥ç³»åˆ—å°ç¦çŠ¶æ€
   - æ–°å¢ `_clear_series_ban()` - æ¸…é™¤ç³»åˆ—å°ç¦
   - ä¿®æ”¹ `mark_credential_error()` - å¢åŠ  error_message å‚æ•°
   - ä¿®æ”¹ `get_valid_credential()` - åœ¨è¿”å›å‰æ£€æŸ¥ç³»åˆ—å°ç¦

2. **src/openai_router.py**ï¼ˆè°ƒç”¨æ›´æ–°ï¼‰
   - ä¿®æ”¹ `mark_credential_error` è°ƒç”¨ï¼Œä¼ é€’å®Œæ•´é”™è¯¯æ¶ˆæ¯

---

## ğŸ¯ æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯ 1ï¼šæ­£å¸¸ 429 é”™è¯¯
1. ä½¿ç”¨ ANT/gemini-3-pro-high å¿«é€Ÿå‘é€è¯·æ±‚ç›´åˆ° 429
2. è§‚å¯Ÿæ—¥å¿—ï¼šåº”æ˜¾ç¤º `[429 BAN]` å’Œå°ç¦æ—¶é•¿
3. éªŒè¯ accounts.toml ä¸­ `gemini_3_series_banned_until` å­—æ®µ
4. å†æ¬¡è¯·æ±‚åŒä¸€ç³»åˆ—ï¼šåº”è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè´¦å·

### æµ‹è¯•åœºæ™¯ 2ï¼šç³»åˆ—éš”ç¦»
1. è§¦å‘ Gemini 3 ç³»åˆ— 429 å°ç¦
2. ç«‹å³è¯·æ±‚ Claude ç³»åˆ—ï¼šåº”æ­£å¸¸ä½¿ç”¨
3. éªŒè¯ä¸åŒç³»åˆ—ç‹¬ç«‹ç®¡ç†

### æµ‹è¯•åœºæ™¯ 3ï¼šè‡ªåŠ¨è§£å°
1. æ‰‹åŠ¨è®¾ç½® `gemini_3_series_banned_until` ä¸ºè¿‡å»æ—¶é—´
2. å‘é€è¯·æ±‚
3. è§‚å¯Ÿæ—¥å¿—ï¼šåº”æ˜¾ç¤º `[429 UNBAN]` å¹¶æ¸…é™¤å­—æ®µ

---

## ğŸ“ é…ç½®ç¤ºä¾‹

**ä¿®æ”¹å‰**ï¼ˆaccounts.tomlï¼‰ï¼š
```toml
[[accounts]]
user_id = "118031974975297336154"
email = "example@gmail.com"
access_token = "ya29.xxx"
# ... å…¶ä»–å­—æ®µ ...
```

**ä¿®æ”¹å**ï¼ˆaccounts.tomlï¼Œè‡ªåŠ¨æ·»åŠ ï¼‰ï¼š
```toml
[[accounts]]
user_id = "118031974975297336154"
email = "example@gmail.com"
access_token = "ya29.xxx"
# ... å…¶ä»–å­—æ®µ ...

# ç³»åˆ—çº§ä¸´æ—¶å°ç¦ï¼ˆè‡ªåŠ¨ç®¡ç†ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ï¼‰
claude_series_banned_until = ""
gemini_3_series_banned_until = "2025-11-29T16:09:36+00:00"
```

---

**å®ç°æ—¥æœŸ**: 2025-11-29
**å®ç°è€…**: Claude Code Assistant
**ç”¨æˆ·éœ€æ±‚**: ç²¾ç»†åŒ– 429 ç®¡ç†ï¼ŒæŒ‰ç³»åˆ—ä¸´æ—¶å°ç¦ï¼Œé¿å…è¿‡åº¦å‹æ¦¨
